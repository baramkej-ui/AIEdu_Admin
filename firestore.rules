/**
 * @fileoverview Firestore Security Rules for AIEdu Platform
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model with user-level ownership for specific data.
 * It prioritizes secure data access and prevents unauthorized modifications.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. The document ID is the Firebase Auth UID.
 * - /problems/{problemId}: Stores quiz problems, accessible to all authenticated users for reading.
 * - /studentProgress/{studentProgressId}: Stores student progress records, with access restricted to the student.
 * - /levelTests/{testId}: Stores configuration for level tests.
 * - /rolePlayScenarios/{scenarioId}: Stores scenarios for role-playing exercises.
 *
 * Key Security Decisions:
 * - User listing is restricted to admin and teacher roles.
 * - The 'role' field in the user document determines admin/teacher privileges.
 * - Data validation is minimized in this prototyping phase, focusing on access control.
 *
 * Denormalization for Authorization:
 * - The user's role ('admin', 'teacher', 'student') is stored directly in the /users/{userId} document. This avoids the need for separate role lookups when evaluating rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserRole(userId) {
        return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isAdmin() {
        return isSignedIn() && getUserRole(request.auth.uid) == 'admin';
    }

    function isTeacher() {
        return isSignedIn() && getUserRole(request.auth.uid) == 'teacher';
    }

    function isAdminOrTeacher() {
        return isAdmin() || isTeacher();
    }

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (get) Signed-in user can read their own profile.
     * @allow (list) Admin or teacher roles can list users.
     * @allow (create) Signed-in user can create their own profile, or an admin/teacher can create any user profile.
     * @allow (update) Signed-in user can update their own profile, or an admin/teacher can update any user profile.
     * @allow (delete) Signed-in user can delete their own profile.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isAdminOrTeacher();
      allow create: if (isSignedIn() && isOwner(userId)) || isAdminOrTeacher();
      allow update: if (isSignedIn() && isOwner(userId)) || isAdminOrTeacher();
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to quiz problem documents.
     * @path /problems/{problemId}
     * @allow (get, list) All authenticated users can read quiz problems.
     * @allow (create, update, delete) Only admin or teacher roles can modify problems.
     */
    match /problems/{problemId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdminOrTeacher();
    }
    
    /**
     * @description Controls access to Role-Play scenario documents.
     * @path /rolePlayScenarios/{scenarioId}
     * @allow (get, list) All authenticated users can read scenarios.
     * @allow (create, update, delete) Only admin or teacher roles can modify scenarios.
     */
    match /rolePlayScenarios/{scenarioId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdminOrTeacher();
    }

    /**
     * @description Controls access to student progress documents.
     * @path /studentProgress/{studentProgressId}
     * @allow (get) All authenticated users can read student progress.
     * @allow (create, update) Students can only create/update their own progress records.
     */
    match /studentProgress/{studentProgressId} {
        function getStudentIdFromProgressId(studentProgressId) {
            return studentProgressId.split('-')[0];
        }

        allow get: if isSignedIn();
        allow list: if false; // No one should be able to list all progress records at once.
        allow create, update: if isSignedIn() && isOwner(getStudentIdFromProgressId(studentProgressId));
        allow delete: if false;
    }

    /**
     * @description Controls access to level test configuration documents.
     * @path /levelTests/{testId}
     * @allow (get, list) Admin or teacher roles can read test configurations.
     * @allow (create, update, delete) Admin or teacher roles can modify test configurations.
     */
    match /levelTests/{testId} {
        allow get, list: if isAdminOrTeacher();
        allow create, update, delete: if isAdminOrTeacher();
    }
  }
}
