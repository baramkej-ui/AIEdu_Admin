/**
 * @fileoverview Firestore Security Rules for AIEdu Platform
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model with user-level ownership for specific data.
 * It prioritizes secure data access and prevents unauthorized modifications.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. The document ID is the Firebase Auth UID.
 * - /problems/{problemId}: Stores quiz problems, accessible to all authenticated users for reading.
 * - /studentProgress/{studentProgressId}: Stores student progress records, with access restricted to the student.
 *
 * Key Security Decisions:
 * - User listing is not allowed.
 * - The 'role' field in the user document determines admin/teacher privileges.
 * - Data validation is minimized in this prototyping phase, focusing on access control and relational integrity.
 *
 * Denormalization for Authorization:
 * - The user's role ('admin', 'teacher', 'student') is stored directly in the /users/{userId} document. This avoids the need for separate role lookups when evaluating rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) Signed-in user can create their own profile if the userId matches their auth.uid.
     * @allow (get, list) Signed-in user can read their own profile.
     * @allow (update, delete) Signed-in user can update/delete their own profile.
     * @deny (create) User cannot create a profile for another user.
     * @deny (update, delete) User cannot update/delete another user's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      // Helper function to check if the user is signed in and owns the document.
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to quiz problem documents.
     * @path /problems/{problemId}
     * @allow (get, list) All authenticated users can read quiz problems.
     * @allow (create) Only admin or teacher roles can create problems.
     * @allow (update, delete) Only admin or teacher roles can update/delete problems.
     * @deny (create, update, delete) Non-admin/teacher roles cannot modify problems.
     * @principle Enforces role-based access control for problem management.
     */
    match /problems/{problemId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isAdminOrTeacher() {
            return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'teacher'];
        }

        allow get, list: if isSignedIn();
        allow create: if isAdminOrTeacher();
        allow update: if isAdminOrTeacher();
        allow delete: if isAdminOrTeacher();
    }

    /**
     * @description Controls access to student progress documents.
     * @path /studentProgress/{studentProgressId}
     * @allow (get) All authenticated users can read student progress.
     * @allow (create, update) Students can only create/update their own progress records.
     * @deny (create, update) Students cannot modify other student's progress records.
     * @principle Enforces user-level ownership for student progress data.
     */
    match /studentProgress/{studentProgressId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(studentId) {
            return request.auth != null && request.auth.uid == studentId;
        }

        function getStudentIdFromProgressId(studentProgressId) {
            return studentProgressId.split('-')[0];
        }

        allow get: if isSignedIn();
        allow list: if false;
        allow create: if isSignedIn() && request.auth.uid == getStudentIdFromProgressId(studentProgressId);
        allow update: if isSignedIn() && request.auth.uid == getStudentIdFromProgressId(studentProgressId);
        allow delete: if false;
    }
  }
}
