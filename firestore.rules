/**
 * @file Firestore Security Rules for EduQuiz Platform
 * @description This ruleset enforces a strict user-ownership model for users, problems and student progress, with teachers owning problems and students owning progress records.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only to the owning user and potentially admins (not implemented here).
 * - /users/{teacherId}/problems/{problemId}: Stores problems created by teachers. Only the teacher can manage their problems.
 * - /users/{studentId}/studentProgress/{studentProgressId}: Stores student progress data. Only the student can access their own progress.
 *
 * Key Security Decisions:
 * - User data is strictly private; listing all users is disallowed.
 * - Only authenticated users can access data. Anonymous authentication is enabled.
 * - The 'role' field within the user document is not used in this ruleset to control authorization due to the prototyping philosophy. The system focuses on ownership based on document paths.
 * - Authorization Independence: The rules avoid `get()` calls by denormalizing authorization data directly onto the secured documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own profile if the userId matches their auth UID.
     * @allow (get, update, delete) - Authenticated user can only access their own profile.
     * @deny (create) - User attempts to create a profile with a different userId.
     * @deny (list) - Listing all users is not allowed.
     * @principle Enforces document ownership for writes and restricts access to a user's own data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to problems created by teachers.
     * @path /users/{teacherId}/problems/{problemId}
     * @allow (create) - Teacher can create a problem under their ID.
     * @allow (get, list, update, delete) - Teacher can access, list, update and delete their own problems.
     * @deny (create, update, delete) - Non-teacher users cannot create, update, or delete problems under another teacher's ID.
     * @principle Enforces document ownership, allowing teachers to manage their own created problems.
     */
    match /users/{teacherId}/problems/{problemId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(teacherId) {
        return isSignedIn() && request.auth.uid == teacherId;
      }

      function isExistingOwner(teacherId) {
        return isOwner(teacherId) && resource != null;
      }

      allow get: if isOwner(teacherId);
      allow list: if isOwner(teacherId);
      allow create: if isOwner(teacherId);
      allow update: if isExistingOwner(teacherId);
      allow delete: if isExistingOwner(teacherId);
    }

    /**
     * @description Controls access to student progress data.
     * @path /users/{studentId}/studentProgress/{studentProgressId}
     * @allow (create) - Student can create their own progress data.
     * @allow (get, list, update, delete) - Student can access, list, update and delete their own progress data.
     * @deny (create, update, delete) - Non-student users cannot create, update, or delete progress data under another student's ID.
     * @principle Enforces document ownership, allowing students to manage their own progress data.
     */
    match /users/{studentId}/studentProgress/{studentProgressId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(studentId) {
        return isSignedIn() && request.auth.uid == studentId;
      }

      function isExistingOwner(studentId) {
        return isOwner(studentId) && resource != null;
      }

      allow get: if isOwner(studentId);
      allow list: if isOwner(studentId);
      allow create: if isOwner(studentId);
      allow update: if isExistingOwner(studentId);
      allow delete: if isExistingOwner(studentId);
    }
  }
}